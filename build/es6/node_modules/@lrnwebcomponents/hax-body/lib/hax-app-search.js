import{html as e,css as t}from"../../../lit-element/lit-element.js";import{SimpleColors as i}from"../../simple-colors/simple-colors.js";import"../../../@polymer/iron-ajax/iron-ajax.js";import{HAXStore as a}from"./hax-store.js";import{autorun as s,toJS as o}from"../../../mobx/dist/mobx.esm.js";class HaxAppSearch extends i{static get styles(){return[...super.styles,t`
        :host {
          display: block;
        }
        hexagon-loader {
          display: none;
          justify-content: center;
          width: 100%;
          z-index: 1000;
          position: absolute;
          --hexagon-color: var(--hax-color-bg-accent, #0085ba);
        }
        hexagon-loader[loading] {
          display: block;
          opacity: 0.8;
        }
        .card-content {
          padding: 16px;
        }
        .card-content p {
          padding: 0;
          margin: 0;
        }
        #itemlist {
          min-height: 172px;
          text-align: center;
          align-items: center;
        }
        hax-app-search-inputs {
          min-height: 80px;
          padding: 0 16px;
        }
        hax-app-pagination {
          min-height: 32px;
          font-size: 12.8px;
          display: none;
          justify-content: flex-end;
          justify-content: center;
        }
        .tos-text {
          font-size: 12px;
        }
        .tos-text ul {
          padding: 4px;
          margin: 0 16px;
        }
        .tos-text a {
          font-size: 12px;
          color: blue;
          text-decoration: underline;
        }
        .tos-text a:hover,
        .tos-text a:focus,
        .tos-text a:active {
          outline: 2px solid blue;
        }
      `]}constructor(){super(),this.auto=!1,this.headers={},this.method="GET",this.loading=!1,this.requestData={},this.media=[],this.tos=[],this.resultMap={},import("../../simple-fields/lib/simple-fields-field.js"),import("../../simple-fields/lib/simple-fields-container.js"),import("../../hexagon-loader/hexagon-loader.js"),import("./hax-app-search-inputs.js"),import("./hax-app-search-result.js"),s(()=>{this.activeApp=o(a.activeApp)})}render(){return e`
      <iron-ajax
        id="request"
        handle-as="json"
        @last-response-changed="${this.requestDataChanged}"
        @loading-changed="${this._loadingChanged}"
        debounce-duration="200"
      ></iron-ajax>
      ${this.tos.length>0?e`
            <div class="tos-text">Terms of service:</div>
            <ul class="tos-text">
              ${this.tos.map(t=>e`
                  <li>
                    <a
                      href="${t.link}"
                      target="_blank"
                      rel="noopener nofollow noreferrer"
                      >${t.title}</a
                    >
                  </li>
                `)}
            </ul>
          `:""}
      <hax-app-search-inputs
        id="searchinput"
        .label="${this.label}"
        .schema="${this.searchSchema}"
        @search-values-changed="${this._searchValuesChanged}"
      ></hax-app-search-inputs>
      <hax-app-pagination
        id="pagerbottom"
        .request-data="${this.requestData}"
        .pagination="${this.pagination}"
      ></hax-app-pagination>
      <hexagon-loader
        size="medium"
        item-count="4"
        ?loading="${this.loading}"
        aria-roledescription="Loading"
      ></hexagon-loader>
      <div id="itemlist">
        ${this.media.map(t=>e`
            <hax-app-search-result
              image="${t.image}"
              title="${t.title}"
              details="${t.details}"
              .map="${t.map}"
              type="${t.type}"
            ></hax-app-search-result>
          `)}
      </div>
    `}requestDataChanged(e){this.requestData=e.detail.value}updated(e){e.forEach((e,t)=>{["auto","method","headers"].includes(t)&&(this.shadowRoot.querySelector("#request")[t]=this[t]),"requestEndPoint"!=t&&"requestParams"!=t||(this.shadowRoot.querySelector("#request").url=this.requestUrl(this.requestEndPoint,this.requestParams)),"activeApp"==t&&this._resetAppSearch(this[t],e),"requestData"==t&&this._requestDataChanged(this[t],e)})}requestUrl(e="",t={}){var i="";if(null!=a.connectionRewrites.appendUploadEndPoint&&t.__HAXAPPENDUPLOADENDPOINT__&&(i=a.connectionRewrites.appendUploadEndPoint+"&"),null!=a.connectionRewrites.appendJwt&&t.__HAXJWT__&&(t[a.connectionRewrites.appendJwt]=localStorage.getItem(a.connectionRewrites.appendJwt)),i+=this.queryStringData(t)){var s=e.indexOf("?")>=0?"&":"?";return e+s+i}return e}queryStringData(e){var t,i,a=[];for(t in e)if(i=e[t],"__HAXJWT__"==t||"__HAXAPPENDUPLOADENDPOINT__"==t);else if(Array.isArray(i))for(var s=0;s<i.length;s++)a.push(t+"="+window.encodeURIComponent(i[s]));else null!==i?a.push(t+"="+window.encodeURIComponent(i)):a.push(t);return a.join("&")}static get tag(){return"hax-app-search"}static get properties(){return{activeApp:{type:Object},tos:{type:Array},auto:{type:Boolean},searchSchema:{type:Object},headers:{type:Object},method:{type:String},loading:{type:Boolean},requestData:{type:Object},media:{type:Array},requestEndPoint:{type:String},requestParams:{type:Object},resultMap:{type:Object}}}_searchValuesChanged(e){let t=this.requestParams;for(let i in e.detail)""!=e.detail[i]&&(t[i]=e.detail[i]);this.requestParams={...this.requestParams}}_resetAppSearch(e,t){if(e&&e.details){let t=e;var i={};this.label=t.details.title,t.details.tos&&t.details.tos.length>0?this.tos=[...t.details.tos]:this.tos=[],this.label=t.details.title,this.auto=!1,this.media=[],void 0!==t.connection.data&&(i=t.connection.data),void 0!==t.connection.operations.browse.data&&(i=Object.assign(i,t.connection.operations.browse.data)),this.method=t.connection.operations.browse.method,this.headers={},void 0!==t.connection.headers&&(this.headers=t.connection.headers),this.requestParams={},this.requestParams=i;var a=t.connection.protocol+"://"+t.connection.url;"/"!=a.substr(a.length-1)&&(a+="/"),void 0!==t.connection.operations.browse.endPoint&&(a+=t.connection.operations.browse.endPoint),this.requestEndPoint=a,this.searchSchema={};var s={properties:{}};void 0!==t.connection.operations.browse.search&&(s.properties=t.connection.operations.browse.search,this.searchSchema=s),this.resultMap=t.connection.operations.browse.resultMap,this.pagination={},void 0!==t.connection.operations.browse.pagination&&(this.pagination=t.connection.operations.browse.pagination),void 0!==t.connection.auto?this.auto=t.connection.auto:this.auto=!0}}_requestDataChanged(e,t){if(this.resultMap&&typeof e!={}&&void 0!==t){let t=[],o=this.resultMap,r=[];if(this.resultMap.items?void 0!==this._resolveObjectPath(o.items,e)?r=this._resolveObjectPath(o.items,e):null!=e&&(r=e):r=e,null!=r){for(var i=0;i<r.length;i++){if(t[i]={title:this._resolveObjectPath(o.preview.title,r[i]),details:this._resolveObjectPath(o.preview.details,r[i]),type:o.defaultGizmoType,map:{}},void 0!==t[i].details&&null!=t[i].details&&(t[i].details=t[i].details.replace(/(<([^>]+)>)/gi,"")),o.preview.id.constructor===Object){let e=this._resolveObjectPath(o.preview.id.property,r[i]);"split"===o.preview.id.op&&(e=e.split(o.preview.id.delimiter),t[i].id=e[o.preview.id.position])}else t[i].id=this._resolveObjectPath(o.preview.id,r[i]);for(var s in void 0!==o.preview.image?t[i].image=this._resolveObjectPath(o.preview.image,r[i]):void 0!==o.image?t[i].image=o.image:t[i].image="",o.gizmo)if("_url_source"===s){let e="";e=void 0!==t[i].map.__id?t[i].map.__id:this._resolveObjectPath(o.gizmo.id,r[i]),t[i].map.source=o.gizmo._url_source.replace("<%= id %>",e),t[i].map.url=t[i].map.source}else if(o.gizmo[s].constructor===Object){let e=this._resolveObjectPath(o.gizmo[s].property,r[i]);"split"===o.gizmo[s].op&&(e=e.split(o.gizmo[s].delimiter),t[i].map[s]=e[o.gizmo[s].position],"id"===s&&(t[i].map.__id=t[i].map[s]))}else t[i].map[s]=this._resolveObjectPath(o.gizmo[s],r[i]);void 0===t[i].map.url&&void 0!==t[i].map.source&&(t[i].map.url=t[i].map.source),void 0!==o.gizmo.type?t[i].type=this._resolveObjectPath(o.gizmo.type,r[i]):void 0!==o.gizmo.mimetype?t[i].type=a.mimeTypeToGizmoType(this._resolveObjectPath(o.gizmo.mimetype,r[i])):"*"!=a.guessGizmoType(o.gizmo)&&(t[i].type=a.guessGizmoType(o.gizmo))}this.media=[...t]}}}_loadingChanged(e){this.loading=e.detail.value}_resolveObjectPath(e,t){return e.split(".").reduce((function(e,t){return e?e[t]:null}),t||self)}}window.customElements.define(HaxAppSearch.tag,HaxAppSearch);export{HaxAppSearch};