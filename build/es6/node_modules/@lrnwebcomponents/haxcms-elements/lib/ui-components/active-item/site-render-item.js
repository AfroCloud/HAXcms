import{html,PolymerElement}from"../../../../../@polymer/polymer/polymer-element.js";import{pathFromUrl}from"../../../../../@polymer/polymer/lib/utils/resolve-url.js";import{dom}from"../../../../../@polymer/polymer/lib/legacy/polymer.dom.js";import{microTask}from"../../../../../@polymer/polymer/lib/utils/async.js";import{store}from"../../core/haxcms-site-store.js";import"../../../../../@polymer/iron-ajax/iron-ajax.js";import{autorun,toJS}from"../../../../../mobx/lib/mobx.module.js";class SiteRenderItem extends PolymerElement{static get tag(){return"site-render-item"}static get template(){return html`
      <style>
        :host {
          display: block;
        }
      </style>
      <iron-ajax
        id="content"
        url="[[location]]"
        handle-as="text"
        loading="{{loading}}"
        debounce-duration="250"
        last-response="{{itemContent}}"
      ></iron-ajax>
      <slot></slot>
    `}static get properties(){return{render:{type:Boolean,value:!1},itemId:{type:String},location:{type:String,computed:"_computeLocation(itemId, render)",observer:"locationChanged"},itemContent:{type:String,notify:!0,observer:"_itemContentChanged"}}}_computeLocation(itemId,render){if(itemId&&render){let item=store.findItem(itemId);return item.location+"?"+Math.floor(Date.now()/1e3)}}locationChanged(newValue){if(newValue){this.$.content.generateRequest()}}_itemContentChanged(newValue){if(newValue){var html=newValue;if(null!==html){html=this.encapScript(newValue);this.wipeSlot(this,"*");microTask.run(()=>{setTimeout(()=>{let frag=document.createRange().createContextualFragment(html);dom(this).appendChild(frag)},5)});if(this.manifest.metadata.dynamicElementLoader){let tagsFound=this.findTagsInHTML(html);const basePath=pathFromUrl(decodeURIComponent(import.meta.url));for(var i in tagsFound){const tagName=tagsFound[i];if(this.manifest.metadata.dynamicElementLoader[tagName]&&!window.customElements.get(tagName)){import(`${basePath}../../../../../${this.manifest.metadata.dynamicElementLoader[tagName]}`).then(()=>{}).catch(error=>{console.log(error)})}}}}}}findTagsInHTML(html){let tags={},tag="";var matches=html.match(/<\/(\S*?)-(\S*?)>/g);for(var i in matches){tag=matches[i].replace("</","").replace(">","");tags[tag]=tag}return tags}encapScript(html){html=html.replace(/<script[\s\S]*?>/gi,"&lt;script&gt;");html=html.replace(/<\/script>/gi,"&lt;/script&gt;");html=html.replace(/<style[\s\S]*?>/gi,"&lt;style&gt;");html=html.replace(/<\/style>/gi,"&lt;/style&gt;");html=html.replace(/<template[\s\S]*?>[\s\S]*?&lt;script[\s\S]*?&gt;[\s\S]*?&lt;\/script&gt;/gi,function(match){match=match.replace("&lt;script&gt;","<script>");match=match.replace("&lt;/script&gt;","</script>");match=match.replace("&lt;style&gt;","<style>");match=match.replace("&lt;/style&gt;","</style>");return match});return html}wipeSlot(element,slot="*"){if("*"===slot){while(null!==dom(element).firstChild){dom(element).removeChild(dom(element).firstChild)}}else{for(var i in dom(element).childNodes){if(typeof dom(element).childNodes[i]!==typeof void 0&&dom(element).childNodes[i].slot===slot){dom(element).removeChild(dom(element).childNodes[i])}}}}connectedCallback(){super.connectedCallback();this.__disposer=[];autorun(reaction=>{this.manifest=toJS(store.manifest);this.__disposer.push(reaction)})}disconnectedCallback(){for(var i in this.__disposer){this.__disposer[i]}super.disconnectedCallback()}}window.customElements.define(SiteRenderItem.tag,SiteRenderItem);export{SiteRenderItem};